# Embedded Linux size reduction techniques
## 自己紹介
- Michael Opdenacker
- free electronsの創業者で組み込みLinuxのエンジニア
- フランスのOrangeという通信会社の出身
- 組み込みLinuxの起動時間を早くする技術に興味があった

## カーネル/システムのサイズを減らす理由
- IoTデバイスで動作
- 起動も早くなる
- 消費電力も減る
- セキュリティとしても攻撃面が減る
- RAMの空きをアプリケーションに活用できる

## 今回話す理由
- ELCE 2015からサイズに関するセッションはなかった
- カーネルを小さくするためのプロジェクトが停止した
- 自分が今までやってこなかった方法を見るいい機会
- カーネルサイズに興味がある人をもう一度集めるいい機会
- 新しいグラフを共有することも良い

## Linux システムをどうやって小さくするのか
- RAM
 - 2~6MBが組み込みカーネルのために必要
 - 8~16MBがユーザ空間のために必要
 - 残りのRAMはパフォーマンスを左右する
- Storage
 - 組み込みカーネルは2~4MB
 - ユーザ空間は数百KB
 - 複雑でないユーザ空間なら8~16MBで十分

## コンパイラの最適化
- gccを使うときはオプション -Os をつけるとバイナリサイズを最小化できる
- オプション -Os は -O2 の最適化をサイズの増加なしで行える

## 最近のコンパイラを使う
- 汎用ARMのLinuxでコンパイルする
 - gcc 4.7 →407512 bytes (zImage)
 - gcc 6.2 →405968 bytes (zImage) -0.4%
   - zImage: カーネルイメージを圧縮したファイル

## gcc LTO の最適化を使う
- LTO : Link Time Optimization
- コードをリンクするときに不要なコードを排除する
- ソースファイルが一つしかないときにもやってくれる
- LTOを使ったコンパイルをするには gcc -Os -flto hogehoge.c -lm

## gcc LTOの最適化をした結果
- x86_64 で gcc 6.2
 - LTO未利用：2122624 bytes (unstripped), 1964432 bytes (stripped)
 - LTO利用：2064480 bytes (unstripped, -2.7%), 1915016 bytes (stripped, -2.6%)
- armelhf で gcc 6.2
 - LTO未利用： 1157588 bytes (unstripped), 1018972 bytes (stripped)
 - LTO利用：1118480 bytes (unstripped, -3.4%), 990248 bytes (stripped, -2.8%)
   - stripped : LTO以外の最適化を有効
   - unstripped : LTO以外の最適化を無効
- x86_64がarmよりも悪いわけではない．64bitシステムの方が32bitシステムよりも大きくなるから結果が違う

## gcc vs clang
- gcc 6.2.0 on x86_64
 - 1964432 bytes
 - with LTO: 1964432 bytes (-2.7%)
- clang 3.8.1 on x86_64
 - 1865592 bytes (-5%)
- gccはhelloworld.cのような小さいプログラムの時に勝てる

## ARM: arm 命令セット vs thumb 命令セット
-  ARM 32bitアーキテクチャでは，arm 命令セット(32bit長)とthumb 命令セット(16bit長)のどちらかを使うことができる
- arm modeでコンパル  
1323860 bytes
- thumb modeでコンパイル  
1233716 bytes (-6.8%)
- thumb命令はよりコンパクトだが，より多くの命令が必要
- arm modeを使ったテストでは，ArmとThumbのコードが混ざったバイナリだった

## 小さいカーネルを入手するには
- make tinyconfigを実行する
- カーネルに必要最低限な設定とカーネルサイズを減らすための設定をする
- ハードウェアと必要なシステムの特徴をサポートするためには，設定を追加する必要がある

## Linux kernelサイズ
- vmlinuxのファイルサイズの報告だった
- tinyconfigを使った実験ではvmlinuxファイルを減らすことができなかったので，結果は小さい
- カーネルは実行時にも割り当てを行う

## 起動するシステム上のカーネルサイズ
- QEMUでARM Versatile Platform BoardをエミュレートしてLinux4.10を起動する
- カーネルがブートできる最小限のRAMは4M(3Mは低すぎ)10年前よりもいい

## カーネルサイズに関するプロジェクトの状態
- カーネル構成のパラメータの管理がすでに困難であるため，構成設定を変更するだけで機能を削除することは不可能
- そのうち，使われていない部分は削除されるかもしれない
- メインライン(コミュニティ開発のカーネル)を開発するボランティアが不足してるのでなんとかしたい

## gcc LTO とLinux kernel
- Andi Kleenが2012年に提供したパッチ
- 必要のないコードを削除することでサイズを減らしパフォーマンスの改善を可能にした ARMでは-6%もサイズが減った
- LTOは新しい問題が発生したり，問題を調査しづらくする．Linusはその時点でツールテェイン(システムプログラムを政策するためのプログラムの集合体)を信用していなかった

## Kernel XIP
- XIP: execution in place
- カーネルテキストをflashし続けることを許可する
- かなり小さいRAMを使ったシステムを動かせる
- ARMはXIPをサポートする唯一のプラットフォーム

## カーネルを小さくするための手助け
- ptraceサポートか再起動なしのLinuxコンパイルを許可すること
- コンパイルログを見て全て必要かどうかをチェックする
- カーネルを小さくする機会や大きい部分を見つける
 - nm --size-sort vmlinux
 - Bloat-O-Meter(大きい部分を見つけるもの)を使って大きくなったサイズを見つける

## LLVM Linux project
- clangを使ってコンパイルをするとパフォーマンスとサイズの最適化が可能になり，gcc LTOよりも優れたものになる
- このプロジェクトは2015年から停止している
- Bernhadrd Rosenkranzerがパッチを更新しupstreamにまもなくpushされるべきである

## ユーザ空間 BusyBox vs Toybox
ARMでgcc5.4を用いてコンパイル
- Toyboxはサイズを減らしてrootfsが小さいという点では良い
- BusyBoxは構成の自由性・精巧なニーズに対する機能性が良い
- ROB Lamdleyが言うには，Toybox shellはexperimentalであるが，bashに取って代わる存在である．小さいシェルにmkshがある

## glibc vs uclibc vs musl
静的・動的・静的で小さいプログラムなBusyBoxでstripでコンパイル

## super stripを使う
sstripはプログラムの実行に不必要なELFを削除する  
ELF:コンピューターにおける実行ファイルや共有ライブラリ及びコンパイラの出力するオブジェクトファイルの形式
- 数百バイトから数千バイトの節約が予想される
- sstripはアーキテクチャに依存せず，コンパイルが簡単

## その他の軽いライブラリ
- diet libc
 - 2013年にリリースされ，ツールチェーンジェネレータにサポートされていない
 - 小さな静的な実行ファイルを意図していた
- klibc
 - 2014年にリリースされ，ツールチェーンジェネレータにサポートされていない
 - initramfsで使うための小さな静的な実行ファイルを生成することを意図していた
 - 復活させる必要はある？

## 最適化しているライブラリ
- mklibs
 - 与えられた実行ファイルのセットに2つ分かれているライブラリをコピーするだけ
 - 必要のないライブラリを削除する必要がある

## ファイルシステムのサイズを小さくするためには
- 小さいシステムのためには，initramfsで起動するのが最適解である．より早く起動することができる
- 単一の単一の静的実行ファイルにも役立つ
- より大きなサイズの場合は，圧縮ファイルシステムを使うといい

## 結論
- 最近のコミュニティ開発のカーネルにはサイズを小さくする動きはなかったが，カーネルサイズを小さくすることは可能である．(ARM上では405 KBの圧縮ができ，4MBのRAMを搭載したシステムで動作できる)
- コンパイラは clang か gcc LTOを使う（まだカーネル用ではない）
- C ライブラリにはmuslを使うと良い
- シンプルなコマンドラインユーティリティで十分な時はToyboxを使って見ると良い
- 改善の余地はまだある．しかし，カーネルパラメータを増やしたり，テストしたりすることなく不必要な部分を削除するのは難しい．
